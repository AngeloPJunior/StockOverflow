<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <title>Stock Overflow</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { color-scheme: light dark; }
    body{font-family:system-ui,Arial;margin:24px;max-width:980px}
    header{display:flex;justify-content:space-between;align-items:center;gap:16px;margin-bottom:12px}
    form, table{width:100%;margin:12px 0}
    input, select, button{padding:8px;margin:4px}
    table{border-collapse:collapse;width:100%}
    th,td{border:1px solid #ddd;padding:8px}
    th{background:#f6f6f6}
    #auth{display:flex;gap:8px;align-items:center}
    .muted{opacity:.75}
  </style>
</head>
<body>

  <header>
    <div>
      <h1 style="margin:0">Stock Overflow ‚Äî HQs & Livros</h1>
      <section id="resumo" style="margin-top:6px">
        <strong>Resumo do Estoque</strong>
        <div id="totais" class="muted">Carregando...</div>
      </section>
    </div>
    <div>
      <a href="/health" target="_blank">/health</a>
      <div id="auth">
        <span id="user-info" style="font-weight:600;"></span>
        <form id="form-login" style="display:flex;gap:6px;align-items:center;">
          <input id="login-email"  type="email"  placeholder="email"  autocomplete="username"/>
          <input id="login-senha"  type="password" placeholder="senha" autocomplete="current-password"/>
          <button id="btn-login"  type="submit">Login</button>
        </form>
        <button id="btn-logout" style="display:none;">Logout</button>
      </div>
    </div>
  </header>

  <section>
    <h2>Novo Produto</h2>
    <form id="form-produto">
      <input name="titulo" placeholder="T√≠tulo" required />
      <input name="autor"  placeholder="Autor" />
      <input name="editora" placeholder="Editora" />
      <input name="genero"  placeholder="G√™nero" />
      <select name="tipo">
        <option value="HQ">HQ</option>
        <option value="LIVRO">LIVRO</option>
      </select>
      <input name="idioma" placeholder="Idioma" />
      <input name="ano" type="number" placeholder="Ano" />
      <input name="edicao" placeholder="Edi√ß√£o" />
      <input name="codigo" placeholder="C√≥digo/ISBN" />
      <input name="quantidade" type="number" placeholder="Qtd inicial" value="0" />
      <button>Salvar</button>
    </form>
  </section>

  <section>
    <h2>Produtos</h2>
    <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
      <input id="busca" placeholder="Buscar por t√≠tulo..." />
      <button id="btn-buscar">Buscar</button>
      <label>Tipo:
        <select id="filtro-tipo">
          <option value="">Todos</option>
          <option value="HQ">HQ</option>
          <option value="LIVRO">LIVRO</option>
        </select>
      </label>
    </div>

    <table>
      <thead>
        <tr><th>ID</th><th>T√≠tulo</th><th>Autor</th><th>Tipo</th><th>Qtd</th></tr>
      </thead>
      <tbody id="lista"></tbody>
    </table>

    <div id="paginacao" style="margin:8px 0">
      <button id="prev">¬´ Anterior</button>
      <span id="pageInfo" style="margin:0 8px"></span>
      <button id="next">Pr√≥xima ¬ª</button>
    </div>
  </section>

  <section>
    <h2>Movimenta√ß√£o</h2>
    <form id="form-mov">
      <input name="produtoId" type="number" placeholder="ID do produto" required />
      <select name="tipo">
        <option value="ENTRADA">ENTRADA</option>
        <option value="SAIDA">SA√çDA</option>
      </select>
      <input name="quantidade" type="number" placeholder="Quantidade" required />
      <input name="observacao" placeholder="Observa√ß√£o" />
      <button>Registrar</button>
    </form>
  </section>

  <script>
    // ===== Estado global simples =====
    const state = {
      page: 1, limit: 5, q: '', tipo: '',
      token: localStorage.getItem('token') || '',
      user: JSON.parse(localStorage.getItem('user') || 'null')
    };

    // ===== Helper fetch com Authorization autom√°tico para muta√ß√µes =====
    async function api(path, opts = {}) {
      const url = path.startsWith('/') ? path : `/${path}`;
      const headers = { 'Content-Type': 'application/json', ...(opts.headers || {}) };
      const method = (opts.method || 'GET').toUpperCase();
      if (state.token && (method === 'POST' || method === 'PUT' || method === 'DELETE')) {
        headers.Authorization = `Bearer ${state.token}`;
      }
      const res = await fetch(url, { ...opts, headers });
      return res;
    }

    function refreshAuthUI() {
      const form = document.getElementById('form-login');
      const btnLogout = document.getElementById('btn-logout');
      const info = document.getElementById('user-info');
      if (state.token && state.user) {
        form.style.display = 'none';
        btnLogout.style.display = 'inline-block';
        info.textContent = `üë§ ${state.user.nome}`;
      } else {
        form.style.display = 'flex';
        btnLogout.style.display = 'none';
        info.textContent = '';
      }
    }

    // ===== Resumo (relat√≥rio) =====
    async function carregarResumo() {
      try {
        const r = await fetch('/relatorios/estoque');
        if (!r.ok) throw new Error('Falha no relat√≥rio');
        const { HQs=0, Livros=0, Total=0 } = await r.json();
        document.getElementById('totais').innerHTML =
          `<strong>HQs:</strong> ${HQs} ¬∑ <strong>Livros:</strong> ${Livros} ¬∑ <strong>Total:</strong> ${Total}`;
      } catch (e) {
        document.getElementById('totais').textContent = 'Erro ao carregar resumo';
        console.error(e);
      }
    }

    // ===== Lista com pagina√ß√£o e filtros =====
    async function carregar(q=''){
      try {
        state.q = q ?? state.q;
        state.tipo = document.getElementById('filtro-tipo')?.value || '';

        const qs = new URLSearchParams({
          q: state.q || '', tipo: state.tipo || '',
          page: String(state.page), limit: String(state.limit),
        });

        const r = await api(`/produtos?${qs.toString()}`);
        if (!r.ok) throw new Error('Falha ao buscar produtos');
        const data = await r.json();
        const items = Array.isArray(data) ? data : data.items || [];

        document.getElementById('lista').innerHTML = items.map(p =>
          `<tr><td>${p.id}</td><td>${p.titulo}</td><td>${p.autor||''}</td><td>${p.tipo}</td><td>${p.quantidade}</td></tr>`
        ).join('');

        const curr = data.page ?? state.page;
        const pages = data.pages ?? 1;
        document.getElementById('pageInfo').textContent = `P√°gina ${curr} de ${pages}`;
        document.getElementById('prev').disabled = curr <= 1;
        document.getElementById('next').disabled = curr >= pages;

        await carregarResumo();
      } catch (e) {
        console.error(e);
        document.getElementById('lista').innerHTML =
          `<tr><td colspan="5" class="muted">Erro ao carregar produtos</td></tr>`;
      }
    }

    // ===== Bootstrapping =====
    document.addEventListener('DOMContentLoaded', () => {
      // LOGIN
      document.getElementById('form-login').onsubmit = async (e) => {
        e.preventDefault();
        const email = document.getElementById('login-email').value.trim();
        const senha = document.getElementById('login-senha').value.trim();
        if (!email || !senha) return alert('Informe email e senha');

        try {
          const r = await fetch('/auth/login', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email, senha })
          });
          const j = await r.json();
          if (!r.ok) return alert(j.error || 'Falha no login');

          state.token = j.token;
          state.user = j.user;
          localStorage.setItem('token', state.token);
          localStorage.setItem('user', JSON.stringify(state.user));
          refreshAuthUI();
          document.getElementById('login-email').value = '';
          document.getElementById('login-senha').value = '';
          alert('Login realizado!');
        } catch (err) {
          console.error(err);
          alert('Erro de rede ao tentar logar.');
        }
      };

      // LOGOUT
      document.getElementById('btn-logout').onclick = () => {
        state.token = '';
        state.user = null;
        localStorage.removeItem('token');
        localStorage.removeItem('user');
        refreshAuthUI();
        alert('Voc√™ saiu da sess√£o.');
      };

      // Busca e filtros
      document.getElementById('btn-buscar').onclick = () => {
        state.page = 1;
        carregar(document.getElementById('busca').value || '');
      };
      document.getElementById('filtro-tipo').onchange = () => { state.page = 1; carregar(); };

      // Pagina√ß√£o
      document.getElementById('prev').onclick = () => { if (state.page > 1) { state.page--; carregar(); } };
      document.getElementById('next').onclick = () => { state.page++; carregar(); };

      // Form novo produto (precisa login)
      document.getElementById('form-produto').onsubmit = async (e) => {
        e.preventDefault();
        if (!state.token) return alert('Fa√ßa login para cadastrar produtos.');
        const f = new FormData(e.target);
        const body = Object.fromEntries(f.entries());
        body.quantidade = Number(body.quantidade||0);
        try {
          const r = await api('/produtos', { method:'POST', body: JSON.stringify(body) });
          const j = await r.json();
          if (!r.ok) return alert(j.error || 'Erro ao salvar');
          e.target.reset();
          state.page = 1;
          carregar();
        } catch (err) {
          console.error(err);
          alert('Erro de rede ao salvar produto.');
        }
      };

      // Form movimenta√ß√£o (precisa login)
      document.getElementById('form-mov').onsubmit = async (e) => {
        e.preventDefault();
        if (!state.token) return alert('Fa√ßa login para registrar movimenta√ß√µes.');
        const f = new FormData(e.target);
        const body = Object.fromEntries(f.entries());
        body.produtoId = Number(body.produtoId);
        body.quantidade = Number(body.quantidade);
        try {
          const r = await api('/movimentacoes', { method:'POST', body: JSON.stringify(body) });
          const j = await r.json();
          if(!r.ok){ alert(j.error||'Erro'); return; }
          alert(`Mov ok. Saldo atual: ${j.saldoAtual}`);
          e.target.reset();
          carregar();
        } catch (err) {
          console.error(err);
          alert('Erro de rede ao registrar movimenta√ß√£o.');
        }
      };

      // start
      refreshAuthUI();
      carregar();
    });
  </script>
</body>
</html>
